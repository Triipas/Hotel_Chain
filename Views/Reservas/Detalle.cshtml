@model Hotel_chain.Models.Entities.Reserva
@using Hotel_chain.Models.Entities
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Detalle de Reserva";

}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - StayGo</title>
    <link rel="stylesheet" href="~/client/css/main.css?v=8">
    <style>
        .detalle-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .detalle-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .detalle-header h1 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .numero-reserva-grande {
            font-size: 1.8rem;
            color: var(--primary-color);
            font-weight: bold;
            margin-top: 10px;
        }

        .estado-badge-grande {
            display: inline-block;
            padding: 10px 24px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 15px;
        }

        .detalle-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .detalle-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .detalle-card h3 {
            color: var(--accent-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--background-section);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-light);
            font-weight: 500;
        }

        .info-value {
            color: var(--accent-color);
            font-weight: 600;
            text-align: right;
        }

        .habitacion-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .precio-total-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .precio-total-card .label {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .precio-total-card .monto {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .solicitudes-box {
            background: var(--background-section);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .solicitudes-box h4 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .timeline {
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .timeline-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-content strong {
            display: block;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .timeline-content small {
            color: var(--text-light);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn-action {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            text-align: center;
            display: inline-block;
        }

        .btn-volver {
            background: var(--text-light);
            color: white;
        }

        .btn-volver:hover {
            background: var(--text-dark);
            color: white;
        }

        .btn-cancelar-detalle {
            background: #dc3545;
            color: white;
        }

        .btn-cancelar-detalle:hover {
            background: #c82333;
        }

        .btn-cancelar-detalle:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .info-notice {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }

        .info-notice h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .info-notice p {
            color: #0c5460;
            margin: 5px 0;
        }

        @@media (max-width: 768px) {
            .detalle-grid {
                grid-template-columns: 1fr;
            }

            .detalle-card {
                padding: 20px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .numero-reserva-grande {
                font-size: 1.4rem;
            }

            .precio-total-card .monto {
                font-size: 2rem;
            }
        }



.rating {
    direction: rtl;
    unicode-bidi: bidi-override;
    display: inline-flex;
    font-size: 2rem;
}

.rating input {
    display: none;
}

.rating label {
    position: relative;
    cursor: pointer;
    color: #ccc;
}

.rating label::before {
    content: "‚òÖ";
}

.rating input:checked ~ label,
.rating label:hover,
.rating label:hover ~ label {
    color: gold;
}

.rating label.half {
    position: relative;
}

.rating label.half::before {
    content: "‚òÖ";
    position: absolute;
    left: 0;
    width: 50%;
    overflow: hidden;
    color: gold;
    pointer-events: none; /* para que no interfiera con el hover */
}
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">StayGo</div>
            <button class="menu-toggle" aria-label="Abrir men√∫">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-derecha">
                <ul class="nav-links">
                    <li><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li><a asp-controller="Hotel" asp-action="Index">Hoteles</a></li>
                    <li><a asp-controller="Reservas" asp-action="BuscarDisponibilidad" style="color: #0077cc;">Reservar</a></li>
                    <li><a asp-controller="Servicios" asp-action="Index">Servicios</a></li>
                    <li><a asp-controller="SobreNosotros" asp-action="Index">Sobre Nosotros</a></li>
                </ul>
                <span>@HttpContextAccessor.HttpContext.Session.GetString("UsuarioNombre")</span>
                <a asp-controller="Reservas" asp-action="MisReservas"><button>Mis Reservas</button></a>
                <a asp-controller="Login" asp-action="Logout"><button>Cerrar Sesi√≥n</button></a>
            </div>
        </nav>
    </header>

    <div class="detalle-container">
        <div class="detalle-header">
            <h1>üìã Detalle de Reserva</h1>
            <div class="numero-reserva-grande">@Model.NumeroReserva</div>
            <div class="estado-badge-grande estado-@Model.Estado.ToLower()">
                @Model.Estado
            </div>
        </div>

        <div class="detalle-grid">
    <!-- Columna izquierda: CARD 1, 2, 3 -->
    <div>
        <!-- CARD 1 ‚Äì Hotel -->
        <div class="detalle-card">
            <h3>üè® Informaci√≥n del Alojamiento</h3>

            @if (Model.Habitacion?.Hotel?.Imagenes != null && Model.Habitacion.Hotel.Imagenes.Any())
            {
                <img src="~/client/imagenes/@Model.Habitacion.Hotel.Imagenes.First().NombreArchivo" 
                     alt="@Model.Habitacion.Hotel.Nombre"
                     class="habitacion-preview" />
            }

            <div class="info-row">
                <span class="info-label">Hotel:</span>
                <span class="info-value">@Model.Habitacion?.Hotel?.Nombre</span>
            </div>

            <div class="info-row">
                <span class="info-label">Ciudad:</span>
                <span class="info-value">@Model.Habitacion?.Hotel?.Ciudad</span>
            </div>

            <div class="info-row">
                <span class="info-label">Direcci√≥n:</span>
                <span class="info-value">@Model.Habitacion?.Hotel?.Direccion</span>
            </div>

            <div class="info-row">
                <span class="info-label">Tel√©fono:</span>
                <span class="info-value">@Model.Habitacion?.Hotel?.TelefonoContacto</span>
            </div>

            <div class="info-row">
                <span class="info-label">Email:</span>
                <span class="info-value">@Model.Habitacion?.Hotel?.ContactoEmail</span>
            </div>
        </div>

        <!-- CARD 2 ‚Äì Habitaci√≥n -->
        <div class="detalle-card" style="margin-top: 25px;">
            <h3>üõèÔ∏è Informaci√≥n de la Habitaci√≥n</h3>

            @if (Model.Habitacion?.Imagenes != null && Model.Habitacion.Imagenes.Any())
            {
                <img src="~/client/imagenes/@Model.Habitacion.Imagenes.First().NombreArchivo" 
                     alt="@Model.Habitacion.NumeroHabitacion"
                     class="habitacion-preview" />
            }

            <div class="info-row">
                <span class="info-label">Nombre:</span>
                <span class="info-value">@Model.Habitacion?.Nombre</span>
            </div>

            <div class="info-row">
                <span class="info-label">Descripci√≥n:</span>
                <span class="info-value">@Model.Habitacion?.Descripcion</span>
            </div>

            <div class="info-row">
                <span class="info-label">Hu√©spedes:</span>
                <span class="info-value">@Model.Habitacion?.Capacidad</span>
            </div>

            <div class="info-row">
                <span class="info-label">Tipo de cama:</span>
                <span class="info-value">@Model.Habitacion?.TipoCama</span>
            </div>

            <div class="info-row">
                <span class="info-label">Tama√±o (m¬≤):</span>
                <span class="info-value">@Model.Habitacion?.TamanoM2</span>
            </div>
        </div>

        <!-- CARD 3 ‚Äì Amenidades -->
      <div class="detalle-card" style="margin-top: 25px;">
  <h3>‚ú® Amenidades</h3>

@if (ViewBag.Amenidades != null && ((IEnumerable<Hotel_chain.Models.Entities.HabitacionAmenidad>)ViewBag.Amenidades).Any())
{
    <ul>
        @foreach (var amenidad in (IEnumerable<Hotel_chain.Models.Entities.HabitacionAmenidad>)ViewBag.Amenidades)
        {
            <li>@amenidad.Amenidad</li>
        }
    </ul>
}
else
{
    <p>No se registraron amenidades.</p>
}
</div>

<!-- CARD 4 ‚Äì Fechas de Estadia -->
<div class="detalle-card" style="margin-top: 25px;">
    <h3>üìÖ Fechas de Estadia</h3>

    <div class="info-row">
        <span class="info-label">Check-in:</span>
        <span class="info-value">@Model.FechaInicio.ToString("dd/MM/yyyy")</span>
    </div>

    <div class="info-row">
        <span class="info-label">Check-out:</span>
        <span class="info-value">@Model.FechaFin.ToString("dd/MM/yyyy")</span>
    </div>

    <div class="info-row">
        <span class="info-label">N√∫mero de noches:</span>
        <span class="info-value">@Model.NumeroNoches</span>
    </div>
</div>

<!-- CARD 4 ‚Äì Pol√≠ticas del Hotel -->
<div class="detalle-card" style="margin-top: 25px;">
    <h3>üè® Pol√≠ticas del Hotel</h3>

    <div class="info-row">
        <input type="checkbox" id="mascotas" disabled @(Model.Habitacion?.Hotel?.MascotasPermitidas == true ? "checked" : "") />
        <label for="mascotas">Se permiten mascotas</label>
    </div>

    <div class="info-row">
        <input type="checkbox" id="fumar" disabled @(Model.Habitacion?.Hotel?.FumarPermitido == true ? "checked" : "") />
        <label for="fumar">Se permite fumar</label>
    </div>

    @if(!string.IsNullOrEmpty(Model.Habitacion?.Hotel?.PoliticaCancelacion))
    {
        <div class="info-row" style="margin-top: 10px;">
            <strong>Pol√≠tica de cancelaci√≥n:</strong>
            <p>@Model.Habitacion.Hotel.PoliticaCancelacion</p>
        </div>
    }
</div>
    </div>

    <!-- Columna derecha: CARD 4 ‚Äì Informaci√≥n de Pago -->
    <div>
      <div class="detalle-card" style="margin-top: 25px;">
    <h3>üí≥ Resumen de Pago</h3>

    <div class="info-row">
        <span class="info-label">Precio por noche:</span>
        <span class="info-value">S/ @Model.RoomRate?.ToString("N2")</span>
    </div>

    <div class="info-row">
        <span class="info-label">Noches (@Model.NumeroNoches):</span>
        <span class="info-value">S/ @(Model.RoomRate * Model.NumeroNoches)</span>
    </div>

    <div class="info-row">
        <span class="info-label">Subtotal:</span>
        <span class="info-value">S/ @Model.Subtotal?.ToString("N2")</span>
    </div>

    <div class="info-row">
        <span class="info-label">Impuestos y tasas:</span>
        <span class="info-value">S/ @Model.Taxes?.ToString("N2")</span>
    </div>

    <hr />

    <div class="info-row">
        <span class="info-label">M√©todo de pago:</span>
        <span class="info-value">@Model.PaymentMethod</span>
    </div>

    <div class="info-row">
        <span class="info-label">N√∫mero de tarjeta:</span>
        <span class="info-value">**** **** **** XXXX</span>
    </div>

    <hr />

    <div class="info-row">
        <span class="info-label">Fecha de reserva:</span>
        <span class="info-value">@Model.FechaCreacion.ToString("dd/MM/yyyy")</span>
    </div>

</div>

    </div>

    <div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5>Informaci√≥n del Hu√©sped</h5>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-6">
        <strong>Nombre y Apellido:</strong>
        <p>@Model.GuestFirstName @Model.GuestLastName</p>
      </div>
      <div class="col-md-6">
        <strong>N√∫mero de Hu√©spedes:</strong>
        <p>@Model.NumeroHuespedes</p>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <strong>Email:</strong>
        <p>@Model.GuestEmail</p>
      </div>
      <div class="col-md-6">
        <strong>Tel√©fono:</strong>
        <p>@Model.GuestPhone</p>
      </div>
    </div>
  </div>
</div>
    <!-- CARD ‚Äì Acciones -->
<div class="action-buttons">
    @* Si la reserva est√° pendiente -> mostrar bot√≥n cancelar *@
    @if (Model.Estado.ToLower() == "pendiente")
    {
        <button type="button" class="btn-cancelar-detalle"
                onclick="confirmarCancelacion(@Model.ReservaId, '@Model.NumeroReserva')">
            Cancelar Reserva
        </button>
    }

    @* Si la reserva est√° completada -> mostrar bot√≥n calificar *@
    else if (Model.Estado.ToLower() == "completada")
    {
       <button type="button" class="btn-action"
        style="background: #ffc107; color: black;"
        onclick="abrirModalCalificacion()">
    ‚≠ê Calificar Estancia
</button>
    }

    <!-- Imprimir -->
    <button type="button" class="btn-action" style="background: #007bff; color: white;">
        Imprimir
    </button>

    <!-- Enviar Email -->
    <button type="button" class="btn-action" style="background: #17a2b8; color: white;">
        Enviar Email
    </button>

    <!-- Compartir -->
    <button type="button" class="btn-action" style="background: #6c757d; color: white;">
        Compartir
    </button>

    <!-- Volver -->
    <a asp-controller="Reservas" asp-action="MisReservas"
       class="btn-action"
       style="background: #28a745; color: white;">
        Volver a Reservas
    </a>
</div>
</div>
    </div>

    <!-- Formulario oculto para cancelar -->
    <form id="cancelarForm" method="post" style="display: none;">
        <input type="hidden" name="id" id="cancelarId" />
        <input type="hidden" name="motivo" id="cancelarMotivo" />
    </form>

  <div id="modalCalificacion" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
  <form id="formCalificacion">
    @Html.AntiForgeryToken()
</form>
  <div style="background:white; padding:20px; max-width:400px; margin:50px auto; border-radius:10px; position:relative;">
    <h3>Calificar Estancia</h3>
    <p>@Model.Habitacion?.Hotel?.Nombre - @Model.Habitacion?.Hotel?.Ciudad</p>
    
    <label>Calificaci√≥n:</label>
<div class="rating">
    @for (decimal i = 5; i >= 0.5m; i -= 0.5m)
{
    var id = $"star{i}".Replace(".", "_");
    <input type="radio" name="rating" id="@id" value="@i" />
    <label for="@id" class="@(i % 1 == 0.5m ? "half" : "")" title="@i estrellas"></label>
}
</div>
    
    <label>Comentario:</label>
    <textarea id="comentario" rows="4" style="width:100%;"></textarea>
    
    <button type="button" onclick="enviarCalificacion(@Model.ReservaId, @Model.Habitacion.Hotel.HotelId)">Enviar</button>
    <button type="button" onclick="cerrarModal()">Cancelar</button>
  </div>
</div>

    <script src="~/client/js/responsive-navbar.js"></script>

 <script>
function abrirModalCalificacion() {
    document.getElementById('modalCalificacion').style.display = 'block';
}

function cerrarModal() {
    document.getElementById('modalCalificacion').style.display = 'none';
}

async function enviarCalificacion(reservaId, hotelId) {
    const ratingInput = document.querySelector('input[name="rating"]:checked');
    if (!ratingInput) { 
        alert('Selecciona una calificaci√≥n'); 
        return; 
    }

    const calificacion = parseFloat(ratingInput.value);
    const comentario = document.getElementById('comentario').value.trim();

    if (!comentario) { 
        alert('Debes agregar un comentario'); 
        return; 
    }

    const token = document.querySelector('#formCalificacion input[name="__RequestVerificationToken"]').value;

    try {
        const res = await fetch('/Reservas/CalificarEstancia', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': token
            },
            body: JSON.stringify({ reservaId, hotelId, calificacion, comentario })
        });

        if (res.ok) {
            alert('¬°Gracias por tu calificaci√≥n!');
            window.location.reload();
        } else {
            const errorText = await res.text();
            alert('Error al enviar calificaci√≥n: ' + errorText);
        }
    } catch (err) {
        console.error(err);
        alert('Error al enviar calificaci√≥n (problema de conexi√≥n)');
    }
}
</script>
    <script>
        function confirmarCancelacion(reservaId, numeroReserva) {
            const motivo = prompt(`¬øEst√°s seguro de que deseas cancelar la reserva ${numeroReserva}?\n\nPor favor indica el motivo de la cancelaci√≥n:`);
            
            if (motivo !== null && motivo.trim() !== '') {
                document.getElementById('cancelarId').value = reservaId;
                document.getElementById('cancelarMotivo').value = motivo;
                document.getElementById('cancelarForm').action = '/Reservas/Cancelar/' + reservaId;
                document.getElementById('cancelarForm').submit();
            } else if (motivo !== null) {
                alert('Debes proporcionar un motivo para cancelar la reserva.');
            }
        }
    </script>

  
</body>
</html>